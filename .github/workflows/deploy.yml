name: Multi-Cloud Deploy (AWS & GCP)

on:
  push:
    branches:
      - "main"
    tags:
      - 'v*'

env:
  ECR_REPOSITORY: gitactions
  GCP_PROJECT_ID: kdt2-final-project-t1
  GAR_REPOSITORY: gitactions-hjh
  GCP_REGION: asia-northeast3
  GITOPS_REPO: JEONGHO0316/team1-final-cd
  KUSTOMIZE_IMAGE_NAME: petclinic-image-placeholder

permissions:
  contents: read

jobs:
  # ====================================================
  # JOB 1: ë¹Œë“œ ë° ì´ë¯¸ì§€ í‘¸ì‹œ (ê³µí†µ)
  # ====================================================
  ci-build:
    runs-on: ubuntu-latest
    # ë‹¤ìŒ Jobë“¤ì—ê²Œ ë³€ìˆ˜ë¥¼ ë„˜ê²¨ì£¼ê¸° ìœ„í•œ output ì„¤ì •
    outputs:
      image_tag: ${{ steps.set-vars.outputs.image_tag }}
      ecr_registry: ${{ steps.login-ecr.outputs.registry }}
      gar_registry: ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/${{ env.ECR_REPOSITORY }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Login to GAR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.GCP_REGION }}-docker.pkg.dev
          username: _json_key
          password: ${{ secrets.GCP_SA_KEY }}

      - name: Determine Image Tag
        id: set-vars
        run: |
          if [[ "${{ github.ref }}" == "refs/tags/"* ]]; then
            echo "image_tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          else
            SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
            echo "image_tag=main-${SHORT_SHA}" >> $GITHUB_OUTPUT
          fi

      - name: Build and Push Image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          GAR_REGISTRY: ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/${{ env.ECR_REPOSITORY }}
          IMAGE_TAG: ${{ steps.set-vars.outputs.image_tag }}
        run: |
          echo "ğŸš€ Target Version: $IMAGE_TAG"
          
          # 1. Docker ë¹Œë“œ
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .

          # 2. AWS ECR í‘¸ì‹œ (í•­ìƒ ìˆ˜í–‰)
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

          # 3. GCP GAR í‘¸ì‹œ (Tagì¼ ë•Œë§Œ ìˆ˜í–‰)
          if [[ "${{ github.ref }}" == "refs/tags/"* ]]; then
            echo "ğŸ”¥ [Prod Release] Pushing to GCP GAR for DR..."
            docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $GAR_REGISTRY:$IMAGE_TAG
            docker push $GAR_REGISTRY:$IMAGE_TAG
          fi

  # ====================================================
  # JOB 2: Dev í™˜ê²½ ë°°í¬ (Main ë¸Œëœì¹˜ì¼ ë•Œë§Œ)
  # ====================================================
  deploy-dev:
    needs: ci-build
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v2

      - name: Update Dev Manifest
        env:
          ECR_REGISTRY: ${{ needs.ci-build.outputs.ecr_registry }}
          IMAGE_TAG: ${{ needs.ci-build.outputs.image_tag }}
        run: |
          git clone https://${{ secrets.GH_TOKEN }}@github.com/${{ env.GITOPS_REPO }}.git cd-repo
          cd cd-repo
          git config user.name "Github Action"
          git config user.email "action@github.com"

          if [ -d "overlays/dev" ]; then
            cd overlays/dev
            kustomize edit set image ${{ env.KUSTOMIZE_IMAGE_NAME }}=$ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG
            
            git commit -am "ğŸŸ¢ Deploy Dev: $IMAGE_TAG"
            git push
          else
            echo "âŒ Error: overlays/dev not found"
            exit 1
          fi

  # ====================================================
  # JOB 3: Slack ì•Œë¦¼ (Tagì¼ ë•Œë§Œ)
  # ====================================================
  notify-slack:
    needs: ci-build
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack Notification
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          fields: repo,ref,workflow
          custom_payload: |
            {
              "text": " ìš´ì˜(Prod) ë°°í¬ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘!",
              "attachments": [{
                "color": "warning",
                "text": "ë²„ì „: ${{ needs.ci-build.outputs.image_tag }}\nECR ë° GAR ì—…ë¡œë“œ ì™„ë£Œ.\n\nì•„ë˜ ë§í¬ë¡œ ì´ë™ í•˜ì—¬ ìŠ¹ì¸ì„ ëˆŒëŸ¬ì£¼ì„¸ìš” .\n<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}| ! ìŠ¹ì¸í•˜ëŸ¬ ê°€ê¸° !>"
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ====================================================
  # JOB 4: Prod í™˜ê²½ ë°°í¬ (ìŠ¹ì¸ í›„ ì‹¤í–‰)
  # ====================================================
  deploy-prod:
    needs: [ci-build, notify-slack]
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    
    # â­ í•µì‹¬: ì—¬ê¸°ì„œ ìŠ¹ì¸ì„ ê¸°ë‹¤ë¦½ë‹ˆë‹¤ â­
    environment: production 

    steps:
      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v2

      - name: Update Prod Manifests
        env:
          ECR_REGISTRY: ${{ needs.ci-build.outputs.ecr_registry }}
          GAR_REGISTRY: ${{ needs.ci-build.outputs.gar_registry }}
          IMAGE_TAG: ${{ needs.ci-build.outputs.image_tag }}
        run: |
          git clone https://${{ secrets.GH_TOKEN }}@github.com/${{ env.GITOPS_REPO }}.git cd-repo
          cd cd-repo
          git config user.name "Github Action"
          git config user.email "action@github.com"

          # 1. AWS Prod ìˆ˜ì •
          if [ -d "overlays/prod-aws" ]; then
            cd overlays/prod-aws
            kustomize edit set image ${{ env.KUSTOMIZE_IMAGE_NAME }}=$ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG
            cd ../..
          fi

          # 2. GCP DR ìˆ˜ì •
          if [ -d "overlays/prod-gcp" ]; then
            cd overlays/prod-gcp
            kustomize edit set image ${{ env.KUSTOMIZE_IMAGE_NAME }}=$GAR_REGISTRY:$IMAGE_TAG
            cd ../..
          fi

          # 3. Push
          if [[ `git status --porcelain` ]]; then
            git add .
            git commit -m "ğŸ”´ Release Prod: $IMAGE_TAG (Multi-Cloud)"
            git push
            echo "âœ… Prod Manifest updated!"
          else
            echo "âœ… Already up-to-date"
          fi
