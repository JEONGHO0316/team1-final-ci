name: Multi-Cloud Deploy (AWS & GCP)

on:
  push:
    tags:
      - 'v*'

env:
  # ğŸ”´ [ì„¤ì •] ë¦¬ì†ŒìŠ¤ ì´ë¦„ ì •ì˜
  ECR_REPOSITORY: gitactions
  GCP_PROJECT_ID: kdt2-final-project-t1
  GAR_REPOSITORY: gitactions-hjh
  GCP_REGION: asia-northeast3
  GITOPS_REPO: JEONGHO0316/team1-final-cd
  
  # ğŸ”´ [ì¤‘ìš”] kustomization.yamlì— ì ì–´ë‘” ê°€ì§œ ì´ë¯¸ì§€ ì´ë¦„(placeholder)ê³¼ ë˜‘ê°™ì•„ì•¼ í•¨!
  KUSTOMIZE_IMAGE_NAME: petclinic-image-placeholder 

permissions:
  contents: read

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Java ì„¸íŒ…
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # 2. Maven ë¹Œë“œ (ì‹¤í–‰ ê¶Œí•œ ë¬¸ì œ ë°©ì§€ ìœ„í•´ chmod ì¶”ê°€)
      - name: Build with Maven
        run: |
          chmod +x mvnw
          ./mvnw clean package -DskipTests

      # 3. Kustomize ì„¤ì¹˜ (âœ… ì¶”ê°€ë¨: ì•ˆì „í•œ ë™ì‘ì„ ìœ„í•´ í•„ìˆ˜)
      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v2

      # 4. AWS ë¡œê·¸ì¸
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # 5. GCP ë¡œê·¸ì¸
      - name: Google Auth
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Login to GAR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.GCP_REGION }}-docker.pkg.dev
          username: _json_key
          password: ${{ secrets.GCP_SA_KEY }}

      # 6. Docker ë¹Œë“œ & Dual Push
      - name: Build, Tag, and Push Image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          # GAR ì£¼ì†Œ ì¡°í•© (Region-docker.pkg.dev/ProjectID/Repo/Image)
          GAR_REGISTRY: ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/${{ env.ECR_REPOSITORY }}
        run: |
          # íƒœê·¸ ì¶”ì¶œ (refs/tags/v1.0.0 -> v1.0.0)
          IMAGE_TAG=${GITHUB_REF#refs/tags/}
          echo "ğŸš€ Deploy Target Version: $IMAGE_TAG"

          # Docker ë¹Œë“œ
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .

          # GCPìš© íƒœê·¸ ìƒì„± (ë³µì‚¬)
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $GAR_REGISTRY:$IMAGE_TAG

          # AWS ECR í‘¸ì‹œ
          echo "ğŸ“¤ Pushing to AWS ECR..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

          # GCP GAR í‘¸ì‹œ
          echo "ğŸ“¤ Pushing to GCP GAR..."
          docker push $GAR_REGISTRY:$IMAGE_TAG

      # 7. GitOps Manifest ìˆ˜ì • (CD íŠ¸ë¦¬ê±°)
      - name: Update GitOps Manifest
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          GAR_REGISTRY: ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/${{ env.ECR_REPOSITORY }}
        run: |
          IMAGE_TAG=${GITHUB_REF#refs/tags/}
          
          # GitOps ë ˆí¬ í´ë¡  (GH_TOKEN í•„ìˆ˜!)
          git clone https://${{ secrets.GH_TOKEN }}@github.com/${{ env.GITOPS_REPO }}.git cd-repo
          cd cd-repo

          git config user.name "Github Action"
          git config user.email "action@github.com"

          # [AWS Prod ìˆ˜ì •]
          if [ -d "overlays/prod-aws" ]; then
            cd overlays/prod-aws
            # kustomizeë¡œ ì´ë¯¸ì§€ íƒœê·¸ êµì²´
            kustomize edit set image ${{ env.KUSTOMIZE_IMAGE_NAME }}=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
            cd ../..
          else
            echo "âš ï¸ AWS folder not found"
          fi

          # [GCP DR ìˆ˜ì •]
          if [ -d "overlays/prod-gcp" ]; then
            cd overlays/prod-gcp
            # kustomizeë¡œ ì´ë¯¸ì§€ íƒœê·¸ êµì²´
            kustomize edit set image ${{ env.KUSTOMIZE_IMAGE_NAME }}=$GAR_REGISTRY:$IMAGE_TAG
            cd ../..
          else
             echo "âš ï¸ GCP folder not found"
          fi

          # ë³€ê²½ì‚¬í•­ í™•ì¸ ë° í‘¸ì‹œ
          if [[ `git status --porcelain` ]]; then
            git add .
            git commit -m "ğŸš€ Deploy Prod: $IMAGE_TAG (AWS & GCP)"
            git push
          else
            echo "âœ… No changes to commit (Already up-to-date)"
          fi
