name: Multi-Cloud Deploy (AWS & GCP)

on:
  push:
    branches:
      - "main"      # ğŸŸ¢ Dev ë°°í¬ íŠ¸ë¦¬ê±°
    tags:
      - 'v*'        # ğŸ”´ Prod ë°°í¬ íŠ¸ë¦¬ê±°

env:
  ECR_REPOSITORY: gitactions
  GCP_PROJECT_ID: kdt2-final-project-t1
  GAR_REPOSITORY: gitactions-hjh
  GCP_REGION: asia-northeast3
  GITOPS_REPO: JEONGHO0316/team1-final-cd
  KUSTOMIZE_IMAGE_NAME: petclinic-image-placeholder

permissions:
  contents: read

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build with Maven
        run: |
          mvn clean package -DskipTests

      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v2

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Google Auth
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Login to GAR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.GCP_REGION }}-docker.pkg.dev
          username: _json_key
          password: ${{ secrets.GCP_SA_KEY }}

      # -----------------------------------------------------------
      # 6. Docker ë¹Œë“œ & Push (ğŸ› ï¸ ìˆ˜ì •ë¨: íƒœê·¸ ì „ëµ ë³€ê²½)
      # -----------------------------------------------------------
      - name: Build and Push Image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          GAR_REGISTRY: ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/${{ env.ECR_REPOSITORY }}
        run: |
          # ğŸ› ï¸ [ìˆ˜ì • í¬ì¸íŠ¸ 1] íƒœê·¸ ìƒì„± ë¡œì§ ë³€ê²½
          # Tag Pushì¼ ê²½ìš° -> v1.0.0 ê·¸ëŒ€ë¡œ ì‚¬ìš©
          # Main Pushì¼ ê²½ìš° -> main-ì»¤ë°‹í•´ì‹œ (ì˜ˆ: main-a1b2c3d) ë¡œ ë§Œë“¤ì–´ì•¼ ArgoCDê°€ ê°ì§€í•¨!
          
          if [[ "${{ github.ref }}" == "refs/tags/"* ]]; then
            IMAGE_TAG=${{ github.ref_name }}
          else
            SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
            IMAGE_TAG="main-${SHORT_SHA}"
          fi
          
          echo "ğŸš€ Target Version: $IMAGE_TAG"

          # 1. Docker ë¹Œë“œ
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .

          # 2. AWS ECR í‘¸ì‹œ (í•­ìƒ ìˆ˜í–‰)
          echo "ğŸ“¤ Pushing to AWS ECR..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

          # 3. GCP GAR í‘¸ì‹œ (ì¡°ê±´: íƒœê·¸ì¼ ë•Œë§Œ ìˆ˜í–‰)
          if [[ "${{ github.ref }}" == "refs/tags/"* ]]; then
            echo "ğŸ”¥ [Prod Release] Pushing to GCP GAR for DR..."
            docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $GAR_REGISTRY:$IMAGE_TAG
            docker push $GAR_REGISTRY:$IMAGE_TAG
          else
            echo "ğŸ’¤ [Dev Build] Skip GCP Push (ECR Only)"
          fi

      # -----------------------------------------------------------
      # 7-A. Dev ë°°í¬ (ğŸ› ï¸ ìˆ˜ì •ë¨: ê³ ìœ  íƒœê·¸ ì‚¬ìš©)
      # -----------------------------------------------------------
      - name: Update Dev Manifest (dev)
        if: github.ref == 'refs/heads/main'
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          # 1. íƒœê·¸ ìƒì„± (main-ì»¤ë°‹í•´ì‹œ)
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          IMAGE_TAG="main-${SHORT_SHA}"
          echo "ğŸ¯ ëª©í‘œ íƒœê·¸: $IMAGE_TAG"

          # 2. GitOps ë ˆí¬ í´ë¡ 
          git clone https://${{ secrets.GH_TOKEN }}@github.com/${{ env.GITOPS_REPO }}.git cd-repo
          cd cd-repo
          git config user.name "Github Action"
          git config user.email "action@github.com"

          # 3. Dev í´ë” ìˆ˜ì • (ì—¬ê¸°ë¥¼ devë¡œ ë°”ê¿¨ìŠµë‹ˆë‹¤!)
          if [ -d "overlays/dev" ]; then
            cd overlays/dev
            
            echo "ğŸ“ ìˆ˜ì • ì „ íŒŒì¼ ë‚´ìš©:"
            cat kustomization.yaml

            # ì´ë¯¸ì§€ íƒœê·¸ ë³€ê²½
            kustomize edit set image ${{ env.KUSTOMIZE_IMAGE_NAME }}=$ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG
            
            echo "âœ… ìˆ˜ì • í›„ íŒŒì¼ ë‚´ìš©:"
            cat kustomization.yaml

            # 4. ë³€ê²½ì‚¬í•­ ì»¤ë°‹ & í‘¸ì‹œ
            git commit -am "ğŸŸ¢ Deploy Dev: $IMAGE_TAG"
            git push
          else
             # í´ë”ê°€ ì§„ì§œ devê°€ ë§ëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•´ ëª©ë¡ì„ ì¶œë ¥í•©ë‹ˆë‹¤.
             echo "âŒ [ì—ëŸ¬] 'overlays/dev' í´ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
             echo "ğŸ“‚ í˜„ì¬ overlays í´ë” ëª©ë¡:"
             ls -F ../
             exit 1
          fi
       


      # -----------------------------------------------------------
      # 7-B. Prod ë°°í¬ (Tagì¼ ë•Œë§Œ)
      # -----------------------------------------------------------
      - name: Update Prod Manifest (AWS & GCP)
        if: startsWith(github.ref, 'refs/tags/')
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          GAR_REGISTRY: ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/${{ env.ECR_REPOSITORY }}
        run: |
          IMAGE_TAG=${{ github.ref_name }}

          git clone https://${{ secrets.GH_TOKEN }}@github.com/${{ env.GITOPS_REPO }}.git cd-repo
          cd cd-repo
          git config user.name "Github Action"
          git config user.email "action@github.com"

          # 1. AWS Prod ìˆ˜ì •
          if [ -d "overlays/prod-aws" ]; then
            cd overlays/prod-aws
            kustomize edit set image ${{ env.KUSTOMIZE_IMAGE_NAME }}=$ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG
            cd ../..
          fi

          # 2. GCP DR ìˆ˜ì • (GAR ì´ë¯¸ì§€ ì‚¬ìš©)
          if [ -d "overlays/prod-gcp" ]; then
            cd overlays/prod-gcp
            kustomize edit set image ${{ env.KUSTOMIZE_IMAGE_NAME }}=$GAR_REGISTRY:$IMAGE_TAG
            cd ../..
          fi

          # 3. Push
          if [[ `git status --porcelain` ]]; then
            git add .
            git commit -m "ğŸ”´ Release Prod: $IMAGE_TAG (Multi-Cloud)"
            git push
          else
            echo "âœ… Already up-to-date"
          fi
