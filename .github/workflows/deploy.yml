name: Multi-Cloud Deploy (AWS & GCP)

on:
  push:
    tags:
      - 'v*'  # v1.0.0 ê°™ì€ íƒœê·¸ê°€ ë‹¬ë¦´ ë•Œë§Œ ì‹¤í–‰

env:
  # ğŸ”´ [ìˆ˜ì • 1] ë³¸ì¸ì˜ AWS ECR ë¦¬í¬ì§€í† ë¦¬ ì´ë¦„ (ì˜ˆ: my-app)
  ECR_REPOSITORY: 639242342449.dkr.ecr.ap-northeast-2.amazonaws.com/gitactions
  
  # ğŸ”´ [ìˆ˜ì • 2] ë³¸ì¸ì˜ GCP í”„ë¡œì íŠ¸ ID (ì˜ˆ: my-project-12345)
  GCP_PROJECT_ID: kdt2-final project-t1
  
  # ğŸ”´ [ìˆ˜ì • 3] GCP GAR ë¦¬í¬ì§€í† ë¦¬ ì´ë¦„ (ì˜ˆ: my-repo)
  GAR_REPOSITORY: gitactions-hjh
  
  # ğŸ”´ [ìˆ˜ì • 4] GCP ë¦¬ì „ (ì˜ˆ: asia-northeast3)
  GCP_REGION: asia-northeast3
  
  # ğŸ”´ [ìˆ˜ì • 5] GitOps ë¦¬í¬ì§€í† ë¦¬ ì£¼ì†Œ (ì˜ˆ: JEONGHO0316/my-service-ops)
  GITOPS_REPO: JEONGHO0316/team1-final-cd

permissions:
  contents: read

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # 1. AWS ë¡œê·¸ì¸
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      # 2. GCP ë¡œê·¸ì¸
      - name: Google Auth
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Login to GAR
        uses: docker/login-action@v2
        with:
          registry: ${{ env.GCP_REGION }}-docker.pkg.dev
          username: _json_key
          password: ${{ secrets.GCP_SA_KEY }}

      # 3. ë¹Œë“œ ë° í‘¸ì‹œ (AWS & GCP ë™ì‹œ)
      - name: Build, Tag, and Push Image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          GAR_REGISTRY: ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPOSITORY }}
        run: |
          IMAGE_TAG=${GITHUB_REF#refs/tags/}
          echo "Build Start... Tag: $IMAGE_TAG"
          
          # Docker ë¹Œë“œ
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          
          # GCPìš© íƒœê·¸ ì¶”ê°€ (ë³µì œ)
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $GAR_REGISTRY:$IMAGE_TAG
          
          # AWS í‘¸ì‹œ
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          
          # GCP í‘¸ì‹œ
          docker push $GAR_REGISTRY:$IMAGE_TAG

      # 4. GitOps Repo ìˆ˜ì • (kustomize ì‚¬ìš©)
      - name: Update GitOps Manifest
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          GAR_REGISTRY: ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPOSITORY }}
        run: |
          IMAGE_TAG=${GITHUB_REF#refs/tags/}
          
          # GitOps Repo Clone (GH_TOKEN ì‚¬ìš©)
          git clone https://${{ secrets.GH_TOKEN }}@github.com/${{ env.GITOPS_REPO }}.git
          cd my-service-ops
          
          git config user.name "CI Bot"
          git config user.email "ci@bot.com"

          # 4-1. AWSìš© ì„¤ì • ìˆ˜ì • (ECR ì´ë¯¸ì§€)
          if [ -d "overlays/prod-aws" ]; then
            cd overlays/prod-aws
            kustomize edit set image my-app-image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
            cd ../..
          fi

          # 4-2. GCPìš© ì„¤ì • ìˆ˜ì • (GAR ì´ë¯¸ì§€)
          if [ -d "overlays/prod-gcp" ]; then
            cd overlays/prod-gcp
            kustomize edit set image my-app-image=$GAR_REGISTRY:$IMAGE_TAG
            cd ../..
          fi

          # ë³€ê²½ì‚¬í•­ í‘¸ì‹œ
          git add .
          git commit -m "Deploy $IMAGE_TAG (AWS & GCP)" || echo "No changes to commit"
          git push
